# 单点登录API

单点登录采用OIDC(OpenID Connect Discovery)协议，兼容 OAuth2 标准，将万悟的用户信息授权给第三方客户端。





## 单点登录示例

### 1. 万悟开启OAuth

（1）在`.env.bak`文件能找到如下三行OAuth配置，将其复制到`.env`文件中

```shell
WANWU_BFF_OAUTH_SWITCH=0 //OAuth开关，0为关，1为开
WANWU_BFF_OAUTH_RSA_PRIVATE_KEY_PATH=${WANWU_PROJECT_DIR}/oauth_rsa_private.pem //RSA私钥文件
WANWU_BFF_OAUTH_RSA_PUBLIC_KEY_PATH=${WANWU_PROJECT_DIR}/oauth_rsa_public.pem //RSA公钥文件
```

（2）`WANWU_BFF_OAUTH_SWITCH`设置为1

（3）配置RSA密钥对

- 生成RSA密钥对：使用以下命令即可在用户目录下的 `.ssh` 文件夹中生成 `wanwu_rsa_private.pem` 和 `wanwu_rsa_public.pem` 文件

```bash
ssh-keygen -t rsa -b 2048 -m PKCS8 -f ~/.ssh/wanwu_rsa_private.pem -N "" \
  && ssh-keygen -f ~/.ssh/wanwu_rsa_private.pem -e -m PKCS8 > ~/.ssh/wanwu_rsa_public.pem
```

- 修改`WANWU_BFF_OAUTH_RSA_PRIVATE_KEY_PATH`和`WANWU_BFF_OAUTH_RSA_PUBLIC_KEY_PATH`，如下所示

```shell
WANWU_BFF_OAUTH_RSA_PRIVATE_KEY_PATH=~/.ssh/wanwu_rsa_private.pem //RSA私钥文件
WANWU_BFF_OAUTH_RSA_PUBLIC_KEY_PATH=~/.ssh/wanwu_rsa_public.pem //RSA公钥文件
```

（4）重新启动万悟





### 2. 在万悟中注册客户端

注意：`Redirect Uri` **必须包含**

- **协议方案**，如：`http://`, `https://`
- **主机名（Host）**,如：`localhost`, `192.168.1.1` 等

![image-20251113143950866](assets/image-20251113143950866.png)



注册完毕从展示页面获得`Client ID`和`Client Secret`

![image-20251119172137342](assets/image-20251119172137342.png)



### 3. 客户端示例

以下是客户端示例代码，成功运行前需要进行如下配置：

1. 在万悟注册`Redirect Uri`为`http://localhost:9999/callback`的客户端，并获取`Client ID`和`Client Secret`
2. 在下面代码中进行替换：
   - `Your IP`替换万悟的 `IP`
   - `Your Client ID`替换为注册的`Client ID`
   - `Your Client Secret`替换为`Client Secret`
3. 运行客户端:`go run main.go`

```Go
package main

import (
	"context"
	"fmt"
	"net/http"

	"github.com/coreos/go-oidc/v3/oidc"
	"golang.org/x/oauth2"
)

var (
	issuer       = "http://Your IP:8081/service/api/openapi/v1"
	clientID     = "Your Client ID"
	clientSecret = "Your Client Secret"
	redirectURL  = "http://localhost:9999/callback" //客户端的callback，需与注册的Redirect Uri一致
)

func main() {
	ctx := context.Background()

	// Initialize the OIDC provider
	provider, err := oidc.NewProvider(ctx, issuer)
	if err != nil {
		// handle error
		fmt.Println("Error initializing provider: ", err)
		return
	}

	// Configure the OAuth2 client
	oauth2Config := oauth2.Config{
		ClientID:     clientID,
		ClientSecret: clientSecret,
		RedirectURL:  redirectURL,
		Endpoint:     provider.Endpoint(),
		Scopes:       []string{oidc.ScopeOpenID},
	}

	http.HandleFunc("/auth", func(w http.ResponseWriter, r *http.Request) {
		http.Redirect(w, r, oauth2Config.AuthCodeURL("state"), http.StatusFound)
	})

	http.HandleFunc("/callback", func(w http.ResponseWriter, r *http.Request) {

		// CORS
		w.Header().Set("Access-Control-Allow-Origin", "*")
		w.Header().Set("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS")
		w.Header().Set("Access-Control-Allow-Headers", "*")

		// Handle OPTIONS method
		if r.Method == "OPTIONS" {
			w.WriteHeader(http.StatusOK)
			return
		}

		// Verify state and handle errors
		oauth2Token, err := oauth2Config.Exchange(ctx, r.URL.Query().Get("code"),
			oauth2.SetAuthURLParam("client_id", clientID),
			oauth2.SetAuthURLParam("client_secret", clientSecret))
		if err != nil {
			// handle error
			fmt.Println("Error exchanging token: ", err)
			return
		}

		// Extract the ID Token from OAuth2 token
		rawIDToken, ok := oauth2Token.Extra("id_token").(string)
		if !ok {
			// handle missing token
			fmt.Println("Missing ID token")
			return
		}

		// Parse and verify ID Token payload
		verifier := provider.Verifier(&oidc.Config{ClientID: clientID})
		idToken, err := verifier.Verify(ctx, rawIDToken)
		if err != nil {
			// handle error
			fmt.Println("Error verifying ID token:", err)
			return
		}

		// Extract custom claims
		var claims struct {
			UserID   string `json:"userId"`   // 用户ID
			UserName string `json:"userName"` // 用户名称
		}
		if err := idToken.Claims(&claims); err != nil {
			// handle error
			fmt.Println("Error extracting claims:", err)
			return
		}

		// Use the claims
		fmt.Fprintf(w, "UserID: %s, UserName: %s\n", claims.UserID, claims.UserName)

		//Get userinfo from userinfo_endpoint
		userInfo, err := provider.UserInfo(ctx, oauth2Config.TokenSource(ctx, oauth2Token))
		if err != nil {
			fmt.Println("Error getting user info:", err)
			return
		}
		fmt.Fprintf(w, "Userinfo Endpoint Get Userinfo: %s", userInfo)

	})

	http.ListenAndServe(":9999", nil)
}

```



#### **代码功能**

- **初始化 OIDC Provider**：通过 `oidc.NewProvider` 连接指定的认证服务器。

- **配置 OAuth2 客户端**：使用 `clientID`、`clientSecret` 和 `redirectURL` 构建 OAuth2 配置。

- **登录跳转**：`/auth` 路由将用户重定向到授权端，触发 OIDC 登录流程。

- **回调处理**：`/callback` 路由接收授权码，完成：

  - 交换访问令牌（Access Token）和 ID Token

  - 验证 ID Token 并解析自定义用户信息（UserID、UserName）

  - 调用 UserInfo Endpoint 获取用户详细信息

  - 返回用户信息给前端

- **支持 CORS**：允许跨域请求。



### 4. 访问客户端并授权

1. 浏览器访问`http://localhost:9999/auth` ，将会重定向到万悟的登录页面如下所示：

![image-20251119174502546](assets/image-20251119174502546.png)



2. 输入用户名和密码，登录成功后跳转到授权窗口。如果用户已有登录状态，则会直接跳转到授权窗口。

![image-20251119174622196](assets/image-20251119174622196.png)



3. 点击授权后，客户端与OAuth服务端交互，自动完成OIDC流程。

![image-20251119174857805](assets/image-20251119174857805.png)



4. 客户端能够获得用户的ID Token信息以及详细的Userinfo信息。

![image-20251119175024641](assets/image-20251119175024641.png)





## OpenID配置发现端点 API

### 请求接口

| Type     | Instructions                                                 |
| -------- | ------------------------------------------------------------ |
| 方法     | Http                                                         |
| 请求URL  | OpenID配置发现端点API地址，地址为`issuer+/.well-known/openid-configuration`，例如：<br />`http://172.19.160.229:8081/service/api/openapi/v1/.well-known/openid-configuration` |
| 字符编码 | UTF-8                                                        |
| 请求类型 | GET                                                          |
| 请求格式 | `Content-Type: application/json`                             |
| 响应格式 | `Content-Type: application/json`                             |



### 响应参数

| Parameter                             | Type   | Instructions                                                 |
| ------------------------------------- | ------ | ------------------------------------------------------------ |
| issuer                                | string | 颁发者标识，必须与发现配置的 URL 匹配。                      |
| authorization_endpoint                | string | 用户进行认证和授权的 URL。                                   |
| token_endpoint                        | string | 客户端用于换取 Access Token 和 ID Token 的 URL。             |
| jwks_uri                              | string | 包含用于验证 Token 签名的公开密钥集（JWK Set）的 URL。       |
| userinfo_endpoint                     | string | 用于获取用户额外信息的 URL（需要 Access Token）。            |
| response_types_supported              | array  | 支持的响应类型（如 `code` 授权码模式），目前仅支持授权码模式。 |
| id_token_signing_alg_values_supported | array  | 支持的 ID Token 签名算法。                                   |
| subject_types_supported               | array  | 身份提供商（OP）支持的 Subject 标识符类型，默认为public。    |



### 调用示例

**基本命令**

```bash
curl [Issuer域名]/.well-known/openid-configuration
```

**万悟示例**

```bash
curl http://172.19.160.229:8081/service/api/openapi/v1/.well-known/openid-configuration
```



### 响应示例

```json
{
    "issuer": "http://172.19.160.229:8081/service/api/openapi/v1",
    "authorization_endpoint": "http://172.19.160.229:8081/service/api/openapi/v1/oauth/login",
    "token_endpoint": "http://172.19.160.229:8081/service/api/openapi/v1/oauth/code/token",
    "jwks_uri": "http://172.19.160.229:8081/service/api/openapi/v1/oauth/jwks",
    "userinfo_endpoint": "http://172.19.160.229:8081/service/api/openapi/v1/oauth/userinfo",
    "response_types_supported": [
        "code"
    ],
    "id_token_signing_alg_values_supported": [
        "RS256"
    ],
    "subject_types_supported": [
        "public"
    ]
}
```



## 认证授权入口API

### 请求接口

| Type     | Instructions                                                 |
| -------- | ------------------------------------------------------------ |
| 方法     | Http                                                         |
| 请求URL  | 用户登录授权认证API，重定向到登录授权页面。例如：<br />`http://172.19.160.229:8081/service/api/openapi/v1/oauth/login` |
| 字符编码 | UTF-8                                                        |
| 请求类型 | GET                                                          |
| 请求格式 | `application/x-www-form-urlencoded`                          |
| 响应格式 | HTTP 302 Found                                               |



### 请求参数



| Parameter     | Required | Type   | Instructions                     |
| ------------- | -------- | ------ | -------------------------------- |
| client_id     | 是       | string | 客户端ID。                       |
| redirect_uri  | 是       | string | 授权成功后回调地址，需与注册一致 |
| response_type | 是       | string | 必须为 `code`（授权码模式）      |
| scope         | 是       | string | 如：`openid profile email`       |
| state         | 是       | string | 防止CSRF攻击，最终会带回客户端   |



### 响应参数

在用户授权登录后，最终会重定向到客户端的回调地址并带上授权码，完成OIDC协议流程，参数如下：

```perl
HTTP/1.1 302 Found
Location: https://example.com/callback?code=8f2bcad1f2ac&state=abc123
```



### 调用示例

```bash
curl -v -L "http://172.19.160.229:8081/service/api/openapi/v1/oauth/login?response_type=code&client_id=test_client&redirect_uri=http%3A%2F%2Flocalhost%3A8080%2Fcallback&scope=openid&state=abc123"

```



## 获取Token API

该api用于客户端的回调接口使用授权码向身份提供商请求token，其中包括`access token` 、`id token`和`refresh token`



### 请求接口

| Type     | Instructions                                                 |
| -------- | ------------------------------------------------------------ |
| 方法     | Http                                                         |
| 请求URL  | 用授权码换取token，例如：<br />`http://172.19.160.229:8081/service/api/openapi/v1/oauth/code/token` |
| 字符编码 | UTF-8                                                        |
| 请求类型 | POST                                                         |
| 请求格式 | `application/x-www-form-urlencoded`                          |
| 响应格式 | `Content-Type: application/json`                             |



### 请求参数

| Parameter     | Required | Type   | Instructions                           |
| ------------- | -------- | ------ | -------------------------------------- |
| code          | 是       | string | 授权码                                 |
| client_id     | 是       | string | 客户端ID                               |
| client_secret | 是       | string | 客户端密钥                             |
| redirect_uri  | 是       | string | 客户端回调地址，需与注册一致           |
| grant_type    | 是       | string | 必须为`authorization_code`，授权码模式 |



### 响应参数

| Parameter     | Type   | Instructions             |
| ------------- | ------ | ------------------------ |
| access_token  | string | 访问令牌                 |
| refresh_token | string | 刷新令牌                 |
| id_token      | string | ID令牌                   |
| token_type    | string | 令牌类型，固定为 Bearer  |
| expires_in    | int    | 令牌过期时间(毫秒时间戳) |
| scope         | array  | 权限范围                 |



### 调用示例

```bash
curl -X POST "http://172.19.160.229:8081/service/api/openapi/v1/oauth/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=authorization_code" \
  -d "code=1234567890abcdef" \
  -d "redirect_uri=http://localhost:8080/callback" \
  -d "client_id=test_client" \
  -d "client_secret=test_secret"
```



### 响应示例

```json
{
  "access_token": "eyJhbGciOi...",
  "expires_in": 1731999999000,
  "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOi...",
  "token_type": "Bearer",
  "refresh_token": "eabcfef12345",
  "scope": ["openid", "profile"]
}

```



## 获取JWT公钥API

### 请求接口

| Type     | Instructions                                                 |
| -------- | ------------------------------------------------------------ |
| 方法     | Http                                                         |
| 请求URL  | 用于验证 Token 签名的公开密钥集（JWK Set）的 URL，例如：<br />`http://172.19.160.229:8081/service/api/openapi/v1/oauth/jwks` |
| 字符编码 | UTF-8                                                        |
| 请求类型 | GET                                                          |
| 响应格式 | `Content-Type: application/json`                             |



### 响应参数

**公钥集**

| Parameter | Type  | Instructions |
| --------- | ----- | ------------ |
| keys      | array | 公钥集       |

**公钥**

| Parameter | Type   | Instructions                      |
| --------- | ------ | --------------------------------- |
| kty       | string | Key 类型，默认RSA                 |
| use       | string | `sig` 表示用于签名                |
| kid       | string | Key ID，JWT 中的 `kid` 会用来匹配 |
| alg       | string | 签名算法，如 `RS256`              |
| n         | string | RSA 模数                          |
| e         | string | RSA 公钥指数                      |

### 调用示例

```bash
curl http://172.19.160.229:8081/service/api/openapi/v1/oauth/jwks
```



### 响应示例

```json
{
  "keys": [
    {
      "kty": "RSA",
      "use": "sig",
      "kid": "1234567890",
      "alg": "RS256",
      "n": "oahUI...（Base64URL）",
      "e": "AQAB",
    }
  ]
}

```





## 刷新Access Token API

### 请求接口

| Type     | Instructions                                                 |
| -------- | ------------------------------------------------------------ |
| 方法     | Http                                                         |
| 请求URL  | 使用`Refresh Token`刷新`Access Token`，例如：<br />`http://172.19.160.229:8081/service/api/openapi/v1/oauth/code/token/refresh` |
| 字符编码 | UTF-8                                                        |
| 请求类型 | POST                                                         |
| 请求格式 | `Content-Type: application/json`                             |
| 响应格式 | `Content-Type: application/json`                             |



### 请求参数

| Parameter     | Required | Type   | Instructions                    |
| ------------- | -------- | ------ | ------------------------------- |
| grant_type    | 是       | string | 访问类型，必须为`refresh_token` |
| client_id     | 是       | string | 客户端ID                        |
| client_secret | 是       | string | 客户端密钥                      |
| refresh_token | 是       | string | refresh_token                   |



### 响应参数

| Parameter     | Type   | Instructions             |
| ------------- | ------ | ------------------------ |
| access_token  | string | 访问令牌                 |
| refresh_token | string | 刷新令牌                 |
| expires_in    | int    | 令牌过期时间(毫秒时间戳) |



### 调用示例

```
curl -X POST \
  http://172.19.160.229:8081/service/api/openapi/v1/oauth/code/token/refresh \
  -H "Content-Type: application/json" \
  -d '{
    "grant_type": "refresh_token",
    "client_id": "你的客户端ID",
    "client_secret": "你的客户端密钥",
    "refresh_token": "你的refresh_token"
  }'
```



### 响应示例

```json
 {
  "code": 0,
  "data": {
    "access_token": "eyJhbGciOiJI....",
    "refresh_token": "c355968f....",
    "expires_at": "1763633925835"
  },
  "msg": ""
}
```





## 获取用户信息API

### 请求接口

| Type                 | Instructions                                                 |
| -------------------- | ------------------------------------------------------------ |
| 方法                 | Http                                                         |
| 请求URL              | 获取用户信息地址，例如：<br />`http://172.19.160.229:8081/service/api/openapi/v1/oauth/userinfo` |
| 字符编码             | UTF-8                                                        |
| 请求类型             | GET                                                          |
| 鉴权方式(header参数) | `Authorization: Bearer {ACCESS TOKEN}`                       |
| 请求格式             | `Content-Type: application/json`                             |
| 响应格式             | `Content-Type: application/json`                             |



### 响应参数

| Parameter | Type   | Instructions                                                 |
| --------- | ------ | ------------------------------------------------------------ |
| code      | int    | 状态码，用于表示请求成功或具体的错误类型                     |
| msg       | string | 提示信息，通常用于提供关于code的详细解释或请求成功的确认信息 |
| data      | array  | 当前响应文本，包含了用户信息                                 |

#### data

| Parameter | Type   | Instructions |
| --------- | ------ | ------------ |
| userId    | string | 用户ID       |
| username  | string | 用户名       |
| nickname  | string | 昵称         |
| phone     | string | 手机号       |
| email     | string | 邮箱         |
| gender    | string | 性别         |
| remark    | string | 备注         |
| company   | string | 单位         |
| avatar    | string | 头像URL      |



### 调用示例

```bash
curl -k --location 'http://172.19.160.229:8081/service/api/openapi/v1/oauth/userinfo' 
--header 'Content-Type: application/json' \
--header 'Accept: application/json' \
--header 'Authorization: Bearer <ACCESS TOKEN>' \
```



### 响应示例

```json
{
  "code": 0,
  "data": {
    "userId": "1",
    "username": "admin",
    "nickname": "admin",
    "phone": "",
    "email": "xxxx@qq.com",
    "gender": "",
    "remark": "",
    "company": "",
    "avatar": "http://172.19.160.229:8081/service/api/v1/cache/avatar/8c/8cc5c71e-bc1f-442e-b814-a67fb112cdfb.jpg"
  },
  "msg": ""
}
```




