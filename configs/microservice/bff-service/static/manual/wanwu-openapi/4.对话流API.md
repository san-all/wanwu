对话流 API
========



## 对话流创建对话API

该接口用于执行指定的对话流并返回运行结果。

### 请求接口

| Type                 | Instructions                                                 |
| -------------------- | ------------------------------------------------------------ |
| 方法                 | Http                                                         |
| 请求URL              | 按照应用实际API根地址，例如：<br />`http://localhost:8081/service/api/openapi/v1/chatflow/conversation` |
| 字符编码             | UTF-8                                                        |
| 请求类型             | POST                                                         |
| 鉴权方式(header参数) | `Authorization: Bearer {API Key}`                            |
| 请求格式             | `Content-Type: application/json`                             |
| 响应格式             | `Content-Type: application/json`                             |

### 请求参数

| Parameter         | Required | Type   | Instructions |
| ----------------- | -------- | ------ | ------------ |
| uuid              | 是       | string | 对话流唯一ID  |
| conversation_name | 是       | string | 对话标题     |

### 响应参数

| Parameter | Type   | Instructions                                                 |
| --------- | ------ | ------------------------------------------------------------ |
| code      | int    | 状态码，用于表示请求成功或具体的错误类型                     |
| msg       | string | 提示信息，通常用于提供关于code的详细解释或请求成功的确认信息 |
| data      | array  | 当前响应文本，包含了根据用户输入和知识库搜索得到的答案       |

#### data

| Parameter       | Type   | Instructions                           |
| --------------- | ------ | -------------------------------------- |
| conversation_id | string | 当前响应文本片段ID                     |

### 调用示例

```shell
curl -X POST -k 'http://localhost:8081/service/api/openapi/v1/chatflow/conversation' \
--header 'Content-Type: application/json' \
--header 'Accept: application/json' \
--header 'Authorization: Bearer <API Key>' \
--data '{
    "uuid":"7582904596348010496",
    "conversation_name":"对话123"
}'

```

### 响应示例

```shell
{
	"code":0,
	"data":{
		"conversation_id":"1234567890"
	},
	"msg":""
}
```



## 对话流对话API

该接口用于执行与指定的对话流ID进行对话。

### 请求接口

| Type                 | Instructions                                                 |
| -------------------- | ------------------------------------------------------------ |
| 方法                 | Http                                                         |
| 请求URL              | 按照应用实际API根地址，例如：<br />`http://localhost:8081/service/api/openapi/v1/chatflow/chat` |
| 字符编码             | UTF-8                                                        |
| 请求类型             | POST                                                         |
| 鉴权方式(header参数) | `Authorization: Bearer {API Key}`                            |
| 请求格式             | `Content-Type: application/json`                             |
| 响应格式             | `Content-Type: application/json`                             |

### 请求参数

| Parameter       | Required | Type   | Instructions           |
| --------------- | -------- | ------ | ---------------------- |
| uuid            | 是       | string | 对话流唯一ID  |
| conversation_id | 是       | string | 历史响应文本片段ID     |
| query           | 是       | string | 用户提出的问题或提示语 |
| parameters      | 否       | map[string]any | 试运行参数 |

### 响应参数

| Parameter | Type   | Instructions                                                 |
| --------- | ------ | ------------------------------------------------------------ |
| id        | int    | 状态码，用于表示请求成功或具体的错误类型                     |
| event     | string | 提示信息，通常用于提供关于code的详细解释或请求成功的确认信息 |
| data      | array  | 模型生成输出的文件url列表                                    |

#### data

| Parameter       | Type   | Instructions                             |
| --------------- | ------ | ---------------------------------------- |
| id              | int64  | 输出文件url                              |
| chat_id         | string | 聊天会话的唯一标识                       |
| conversation_id | string | 对话流的唯一标识，一个对话流包含多个聊天 |
| bot_id          | string | 机器人/助手的唯一标识                    |
| role            | string | 消息发送者的角色                         |
| type            | string | 消息类型                                 |
| content         | string | 消息的实际内容                           |
| content_type    | string | 内容的格式类型                           |
| section_id      | string | 消息所属的段落/章节标识                  |
| status          | enum   | 消息的处理状态                           |
| usage           | array  | 资源使用情况统计                         |
| execute_id      | string | 执行批次或任务的唯一标识                 |
| section_id      | string | 消息所属的段落/章节/区块标识符           |
| debug_url       | string | 调试信息的访问URL                        |

#### usage

| Parameter    | Type  | Instructions  |
| ------------ | ----- | ------------- |
| token_count  | int64 | 总token数量   |
| output_count | int64 | 输出token数量 |
| input_count  | int64 | 输入token数量 |



### 调用示例

#### 通过对话流id进行对话

```shell
curl -k --location --request POST 'http://localhost:8081/service/api/openapi/v1/chatflow/chat' \
--header 'Content-Type: application/json' \
--header 'Accept: application/json' \
--header 'Authorization: Bearer <API Key>' \
--data '{
    "uuid": "7552817719230332928",
    "conversation_id":"1234567890",
    "query":"你好!",
    "parameters":{"test":"test"}
}'
```

#### 对话响应

```json
id: 1
event: conversation.chat.created
data:{
    "id":"7574323086267252736",
    "conversation_id":"7574260908419973120",
    "status":"created",
    "execute_id":"7574323086359527424",
    "section_id":"7574260908419989504"
}

id: 2
event: conversation.chat.in_progress
data: {
    "id":"7574323086267252736",
    "conversation_id":"7574260908419973120",
    "status":"in_progress",
    "execute_id":"7574323086359527424",
    "section_id":"7574260908419989504"
}

id: 3
event: conversation.message.delta
data: {
    "id":"7574323086523105280",
    "chat_id":"7574323086267252736",
    "conversation_id":"7574260908419973120",
    "bot_id":"1763520042510",
    "role":"assistant",
    "type":"answer",
    "content":"你好!",
    "content_type":"text",
    "section_id":"7574260908419989504"
}

id: 4
event: conversation.message.completed
data: {
    "id":"7574323086523105280",
    "chat_id":"7574323086267252736",
    "conversation_id":"7574260908419973120",
    "bot_id":"1763520042510",
    "role":"assistant",
    "type":"answer",
    "content":"你好!",
    "content_type":"text",
    "section_id":"7574260908419989504"
}

id: 5
event: conversation.chat.completed
data: {
    "id":"7574323086267252736",
    "conversation_id":"7574260908419973120",
    "bot_id":"1763520042510",
    "status":"completed",
    "usage":{
        "token_count":0,
        "output_count":0,
        "input_count":0
    },
    "execute_id":"7574323086359527424",
    "section_id":"7574260908419989504"
}

id: 6
event: done
data: {
    "debug_url":"http://172.25.214.210:8081/work_flow?execute_id=7574323086359527424&execute_mode=2&space_id=1&workflow_id=7574260146570788864"
}
```



## 根据对话流ID获取历史对话API

该接口用于执行根据指定的对话流ID获取历史对话。

### 请求接口

| Type                 | Instructions                                                 |
| -------------------- | ------------------------------------------------------------ |
| 方法                 | Http                                                         |
| 请求URL              | 按照应用实际API根地址，例如：<br />`http://localhost:8081/service/api/openapi/v1/chatflow/conversation/message/list` |
| 字符编码             | UTF-8                                                        |
| 请求类型             | POST                                                         |
| 鉴权方式(header参数) | `Authorization: Bearer {API Key}`                            |
| 请求格式             | `Content-Type: application/json`                             |
| 响应格式             | `Content-Type: application/json`                             |

### 请求参数

| Parameter       | Required | Type   | Instructions                           |
| --------------- | -------- | ------ | -------------------------------------- |
| uuid            | 是       | string | 对话流唯一ID  |
| conversation_id | 是       | string | 历史响应文本片段ID                     |
| limit           | 否       | string | 历史对话展示数量                       |

### 响应参数W

| Parameter | Type   | Instructions                               |
| :-------- | :----- | :----------------------------------------- |
| code      | int    | 状态码，0表示成功，非0表示错误             |
| data      | object | 响应数据主体，包含查询结果和分页信息       |
| msg       | string | 提示信息，用于提供操作结果或错误的具体描述 |

### data

| Parameter | Type  | Instructions                 |
| :-------- | :---- | :--------------------------- |
| data      | array | 消息记录列表，按时间倒序排列 |
| first_id  | int64 | 当前页第一条记录的ID         |
| has_more  | bool  | 是否有更多数据可供查询       |
| last_id   | int64 | 当前页最后一条记录的ID       |

#### data[] (消息对象)

| Parameter         | Type   | Instructions                                                 |
| :---------------- | :----- | :----------------------------------------------------------- |
| id                | string | 消息的唯一标识符                                             |
| bot_id            | string | 对话关联的应用ID                                             |
| chat_id           | string | 聊天会话的唯一标识，标识消息所属的聊天会话                   |
| conversation_id   | string | 对话流的唯一标识，一个对话流包含多个相关聊天会话             |
| role              | string | 消息发送者的角色，如：user、assistant、system等              |
| type              | string | 消息类型，如：text、image、file、audio等                     |
| content           | string | 消息的实际内容文本                                           |
| content_type      | string | 内容的格式类型，如：text/plain、application/json、text/html等 |
| section_id        | string | 消息所属的段落/章节/区块标识符，用于结构化对话内容           |
| meta_data         | object | 消息的元数据，包含自定义的扩展信息                           |
| reasoning_content | string | 模型的推理过程内容（如果模型支持推理过程输出）               |
| created_at        | int64  | 消息创建时间戳，Unix时间戳（秒）                             |
| updated_at        | int64  | 消息最后更新时间戳，Unix时间戳（秒）                         |

#### meta_data

| Parameter       | Type   | Instructions                          |
| :-------------- | :----- | :------------------------------------ |
| additionalProp1 | string | 自定义元数据字段1，可根据业务需求扩展 |
| additionalProp2 | string | 自定义元数据字段2，可根据业务需求扩展 |
| additionalProp3 | string | 自定义元数据字段3，可根据业务需求扩展 |

### 调用示例

#### 通过对话流id进行对话

```shell
curl -k --location --request POST 'http://localhost:8081/service/api/openapi/v1/chatflow/conversation/message/list' \
--header 'Content-Type: application/json' \
--header 'Accept: application/json' \
--header 'Authorization: Bearer <API Key>' \
--data '{
    "uuid": "7552817719230332928",
    "conversation_id":"1234567890",
    "limit":"1"
}'
```

#### 对话响应

```json
{
    "code":0,
    "data":{
        "data":[{
            "id":"7582785145170558976",
            "bot_id":"7582778568485109760",
            "role":"assistant",
            "content":"{\"prompt\":\"你好!\",\"score\":[],\"searchList\":[]}",
            "conversation_id":"7582778568543830016",
            "meta_data":null,
            "created_at":1765504746,
            "updated_at":1765504746,
            "chat_id":"7582785125121785856",
            "content_type":"text",
            "type":"answer",
            "section_id":"7582778568543846400",
            "reasoning_content":""
        }],
        "has_more":true,
        "first_id":7582785145170558976,
        "last_id":7582785145170558976
    },
    "msg":""
}
```

